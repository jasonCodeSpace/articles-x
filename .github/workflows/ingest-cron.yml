name: Ingest Cron

on:
  schedule:
    - cron: "*/15 * * * *"   # æ¯ 15 åˆ†é’Ÿï¼ŒUTC æ—¶é—´
  workflow_dispatch: {}       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  call:
    runs-on: ubuntu-latest
    steps:
      - name: Check CRON_SECRET
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "âŒ CRON_SECRET is not set in repository secrets"
            echo "Please add CRON_SECRET to GitHub repository secrets:"
            echo "1. Go to https://github.com/haocheng0919/articles-x/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: CRON_SECRET"
            echo "4. Value: [your secret value from Vercel environment variables]"
            exit 1
          else
            echo "âœ… CRON_SECRET is configured"
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
      
      - name: Hit ingest endpoint (POST with header)
        run: |
          echo "ğŸš€ Triggering ingest for all 26 Twitter lists..."
          echo "ğŸ“… Current time: $(date -u)"
          
          response=$(curl -sS -X POST "https://articles-x.vercel.app/api/ingest" \
            -H "x-cron-secret: $CRON_SECRET" \
            -H "Accept: application/json" \
            -H "User-Agent: GitHub-Actions-Cron" \
            -w "\nHTTP_STATUS:%{http_code}" \
            --max-time 300)
          
          echo "ğŸ“ Response:"
          echo "$response"
          
          # Extract HTTP status code
          http_code=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          # Check if request was successful
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Ingest completed successfully"
          else
            echo "âŒ Ingest failed with HTTP status: $http_code"
            echo "ğŸ” Please check:"
            echo "   - CRON_SECRET matches Vercel environment variable"
            echo "   - API endpoint is accessible"
            echo "   - Twitter API credentials are valid"
            exit 1
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}

concurrency:
  group: ingest-cron
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œé¿å…æ•°æ®å¤„ç†ä¸­æ–­