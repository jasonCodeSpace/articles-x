name: Daily Ingest Cron

on:
  schedule:
    # æ¯15åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œä½†é¿å¼€æ•´ç‚¹é«˜å³°æœŸ (æ¯æ—¥96æ¬¡)
    # åœ¨æ¯å°æ—¶çš„ç¬¬3ã€18ã€33ã€48åˆ†é’Ÿæ‰§è¡Œï¼Œé¿å…GitHub Actionsé«˜è´Ÿè½½æ—¶æ®µ
    - cron: '3,18,33,48 * * * *'
  workflow_dispatch: {}       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  call:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # å¢åŠ æ•´ä¸ª job çš„è¶…æ—¶æ—¶é—´åˆ° 15 åˆ†é’Ÿ
    steps:
      - name: Check CRON_SECRET
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "âŒ CRON_SECRET is not set in repository secrets"
            echo "Please add CRON_SECRET to GitHub repository secrets:"
            echo "1. Go to https://github.com/haocheng0919/articles-x/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: CRON_SECRET"
            echo "4. Value: [your secret value from Vercel environment variables]"
            exit 1
          else
            echo "âœ… CRON_SECRET is configured"
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
      
      - name: Hit ingest endpoint (POST with header)
        run: |
          echo "ğŸš€ Daily scheduled ingest - Triggering ingest for all Twitter lists..."
          echo "ğŸ“… Current UTC time: $(date -u)"
          echo "â° This runs every 15 minutes (96 times per day): 00:00, 00:15, 00:30, 00:45, etc."
          
          response=$(curl -sS -X POST "https://www.xarticle.news/api/ingest" \
            -H "x-cron-secret: $CRON_SECRET" \
            -H "Accept: application/json" \
            -H "User-Agent: GitHub-Actions-Cron" \
            -w "\nHTTP_STATUS:%{http_code}" \
            --max-time 600)  # å¢åŠ  curl è¶…æ—¶åˆ° 10 åˆ†é’Ÿ
          
          echo "ğŸ“ Response:"
          echo "$response"
          
          # Extract HTTP status code
          http_code=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          # Check if request was successful
          if [ "$http_code" -eq 200 ]; then
            echo "âœ… Ingest completed successfully"
          else
            echo "âŒ Ingest failed with HTTP status: $http_code"
            echo "ğŸ” Please check:"
            echo "   - CRON_SECRET matches Vercel environment variable"
            echo "   - API endpoint is accessible"
            echo "   - Twitter API credentials are valid"
            exit 1
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}

concurrency:
  group: ingest-cron
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œé¿å…æ•°æ®å¤„ç†ä¸­æ–­