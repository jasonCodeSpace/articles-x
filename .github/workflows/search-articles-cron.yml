name: Search Articles Cron

on:
  schedule:
    # Run once every 3 months to search for articles from authors
    # Quarterly schedule to minimize Twitter API usage
    - cron: '15 2 1 */3 *'  # At 2:15 AM UTC on the 1st day of every 3rd month
  workflow_dispatch: {}       # Allow manual triggering

jobs:
  search:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Longer timeout since this processes many authors
    steps:
      - name: Check CRON_SECRET
        run: |
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ùå CRON_SECRET is not set in repository secrets"
            echo "Please add CRON_SECRET to GitHub repository secrets:"
            echo "1. Go to https://github.com/haocheng0919/articles-x/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: CRON_SECRET"
            echo "4. Value: [your secret value from Vercel environment variables]"
            exit 1
          else
            echo "‚úÖ CRON_SECRET is configured"
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
      
      - name: Search for articles from authors
        run: |
          echo "üîç Scheduled article search - Searching for articles from all authors..."
          echo "üìÖ Current UTC time: $(date -u)"
          echo "‚è∞ This runs quarterly (every 3 months) to find new articles"
          
          response=$(curl -sS -X POST "https://www.xarticle.news/api/search-articles" \
            -H "x-cron-secret: $CRON_SECRET" \
            -H "Accept: application/json" \
            -H "User-Agent: GitHub-Actions-Search-Cron" \
            -w "\nHTTP_STATUS:%{http_code}" \
            --max-time 1800)  # 30 minutes timeout for search operation
          
          echo "üìù Response:"
          echo "$response"
          
          # Extract HTTP status code
          http_code=$(echo "$response" | grep "HTTP_STATUS:" | cut -d: -f2)
          
          # Check if request was successful
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ Article search completed successfully"
          else
            echo "‚ùå Article search failed with HTTP status: $http_code"
            echo "üîç Please check:"
            echo "   - CRON_SECRET matches Vercel environment variable"
            echo "   - API endpoint is accessible"
            echo "   - Twitter API credentials are valid"
            echo "   - RapidAPI key and host are configured"
            exit 1
          fi
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}

concurrency:
  group: search-articles-cron
  cancel-in-progress: false  # Don't cancel running tasks to avoid interrupting data processing